@implements IDisposable

@* NavMenu: side navigation with role-based sections and logo navigation *@

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@using FinalAssignemnt_APDP.Constants
@using Microsoft.AspNetCore.Components.Web

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />
<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <div class="navbar-brand site-logo"
               role="link"
                   tabindex="0"
                   aria-label="Assignment Final APDP"
                   @onclick="NavigateHome"
                   @onkeydown="HandleLogoKey">
            Assignment Final APDP
        </div>
    </div>
</div>
<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">

        <!-- Lecture Menu -->
        <AuthorizeView Roles="Lecture,Lecturer">
            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.LecturerWorkspace">
                        <span class="bi bi-easel2" aria-hidden="true"></span> Lecturer Hub
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.LecturerClasses">
                        <span class="bi bi-journal-bookmark" aria-hidden="true"></span> Classes
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.LecturerTimetable">
                        <span class="bi bi-clock-history" aria-hidden="true"></span> Timetable
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.LecturerStudents">
                        <span class="bi bi-people" aria-hidden="true"></span> Students
                    </NavLink>
                </div>
            </Authorized>
        </AuthorizeView>

        <!-- Admin Menu -->
        <AuthorizeView Roles="Admin">
            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.AdminDashboard">
                        <span class="bi bi-speedometer2" aria-hidden="true"></span> Admin Hub
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Departments">
                        <span class="bi bi-building" aria-hidden="true"></span> Department
                    </NavLink>
                </div>
                
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Majors">
                        <span class="bi bi-mortarboard" aria-hidden="true"></span> Major
                    </NavLink>
                </div>

                  <div class="nav-item px-3">
                     <NavLink class="nav-link" href="@AppRoutes.Subjects">
                         <span class="bi bi-book" aria-hidden="true"></span> Subject
                     </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Semesters">
                        <span class="bi bi-calendar3" aria-hidden="true"></span> Semester
                    </NavLink>
                </div>
              
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Courses">
                        <span class="bi bi-journal-text" aria-hidden="true"></span> Course
                    </NavLink>
                </div>
               
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Enrollments">
                        <span class="bi bi-person-check" aria-hidden="true"></span> Enrollment
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.AdminGrades">
                        <span class="bi bi-clipboard2-check" aria-hidden="true"></span> Grades
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Users">
                        <span class="bi bi-people-fill" aria-hidden="true"></span> Users
                    </NavLink>
                </div>
            </Authorized>
        </AuthorizeView>

        <!-- Student Menu -->
        <AuthorizeView Roles="Student">
            <Authorized>

                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.StudentDashboard">
                        <span class="bi bi-house-door-fill" aria-hidden="true"></span> Dashboard
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.StudentSchedule">
                        <span class="bi bi-calendar3" aria-hidden="true"></span> Schedule
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.StudentGrades">
                        <span class="bi bi-clipboard-data" aria-hidden="true"></span> Grades
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.StudentCourses">
                        <span class="bi bi-journal-text" aria-hidden="true"></span> Courses
                    </NavLink>
                </div>
            </Authorized>
        </AuthorizeView>

        <AuthorizeView>
            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Profile">
                        <span class="bi bi-person-circle" aria-hidden="true"></span> Profile
                    </NavLink>
                </div>
            </Authorized>
        </AuthorizeView>

        <!-- Logout (All authenticated users) -->
        <AuthorizeView>
            <Authorized>
                <div class="nav-item px-3">
                    <form action="@AppRoutes.Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="/" />
                        <button type="submit" class="nav-link">
                            <span class="bi bi-arrow-bar-left-nav-menu" aria-hidden="true"></span> Logout
                        </button>
                    </form>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Register">
                        <span class="bi bi-person-nav-menu" aria-hidden="true"></span> Register
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="@AppRoutes.Login">
                        <span class="bi bi-person-badge-nav-menu" aria-hidden="true"></span> Login
                    </NavLink>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </nav>
</div>

@code {
    // current relative URL
    private string? currentUrl;

    // subscribe to navigation changes
    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }
    // update currentUrl on location change
    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    // unsubscribe from location changes
    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    // NavigateHome: route to role dashboard or root
    private async Task NavigateHome()
    {
        try
        {
            var state = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = state.User;

            if (user?.Identity?.IsAuthenticated ?? false)
            {
                if (user.IsInRole("Admin"))
                {
                    NavigationManager.NavigateTo(AppRoutes.AdminDashboard);
                    return;
                }

                if (user.IsInRole("Lecture") || user.IsInRole("Lecturer"))
                {
                    NavigationManager.NavigateTo(AppRoutes.LecturerWorkspace);
                    return;
                }

                if (user.IsInRole("Student"))
                {
                    NavigationManager.NavigateTo(AppRoutes.StudentDashboard);
                    return;
                }
            }

            // fallback to root
            NavigationManager.NavigateTo("/");
        }
        catch
        {
            // fallback to root on error
            NavigationManager.NavigateTo("/");
        }
    }
    // Handle keyboard activation of the logo (Enter or Space)
    private async Task HandleLogoKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            await NavigateHome();
        }
    }
}