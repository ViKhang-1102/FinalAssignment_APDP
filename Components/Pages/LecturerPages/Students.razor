@page "/lecturer/students"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Lecture,Lecturer")]
@using System
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@using FinalAssignemnt_APDP.Constants
@using FinalAssignemnt_APDP.Services
@using FinalAssignemnt_APDP.Data
@using FinalAssignemnt_APDP.Components.Pages.LecturerPages
@inherits LecturerTeachingPageBase
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ToastQueue Toasts

<PageTitle>My Students - Grading</PageTitle>

<div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <div class="mb-10 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-violet-500">Learner roster</p>
            <h1 class="text-3xl font-bold text-slate-900">Grade Your Students</h1>
            <p class="text-sm text-slate-500">Enter and update scores for all your students. Each score can be edited up to 2 times.</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <a class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300" href="@AppRoutes.LecturerWorkspace">
                <span class="bi bi-arrow-left"></span> Back to workspace
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
            @ErrorMessage
        </div>
    }
    else if (IsLoading)
    {
        <div class="flex items-center justify-center rounded-xl border border-dashed border-slate-200 bg-white/80 py-16 text-slate-500">
            <div class="flex items-center gap-3"><span class="spinner-border spinner-border-sm"></span> Loading rosters...</div>
        </div>
    }
    else if (!Workspace.HasCourses)
    {
        <div class="rounded-xl border border-dashed border-slate-200 bg-white/80 px-6 py-10 text-center">
            <p class="text-lg font-semibold text-slate-800">No students to display</p>
            <p class="mt-2 text-sm text-slate-500">Assign courses to this lecturer to unlock roster insights.</p>
        </div>
    }
    else
    {
        <!-- Info Banner -->
        <div class="mb-6 rounded-xl border border-indigo-200 bg-indigo-50 p-4">
            <div class="flex items-start gap-3">
                <span class="bi bi-info-circle-fill text-xl text-indigo-600"></span>
                <div class="flex-1 text-sm text-indigo-800">
                    <p class="font-semibold">Grading Guidelines</p>
                    <ul class="mt-2 space-y-1">
                        <li>• Each score (Midterm/Final) can be edited up to <strong>2 times</strong></li>
                        <li>• <strong>Score range: 0 to 100</strong> (negative or >100 scores will be rejected)</li>
                        <li>• Average = (Midterm × 40%) + (Final × 60%)</li>
                        <li>• Letter grades: D (≥90), M (≥80), P (≥65), F (&lt;65)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            @foreach (var course in Workspace.Courses)
            {
                var roster = Workspace.CourseRosters.TryGetValue(course.Id, out var students)
                    ? students
                    : Array.Empty<LecturerRosterRow>();
                var courseGrades = courseGradeInfo.GetValueOrDefault(course.Id, new Dictionary<string, Grade>());
                
                <section class="rounded-2xl border border-slate-100 bg-white p-6 shadow-sm">
                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">@course.Semester</p>
                            <h2 class="text-2xl font-semibold text-slate-900">@course.Name</h2>
                            <p class="text-sm text-slate-500">@course.Subject · @course.ScheduleSummary</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 px-4 py-2 text-sm font-semibold text-slate-600">
                                <span class="bi bi-people"></span> @roster.Count learners
                            </span>
                        </div>
                    </div>

                    @if (roster.Count == 0)
                    {
                        <div class="mt-6 rounded-lg border border-dashed border-slate-200 px-4 py-6 text-center text-sm text-slate-500">
                            No enrollments recorded for this course yet.
                        </div>
                    }
                    else
                    {
                        <div class="mt-6 overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-100 text-sm">
                                <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                                    <tr>
                                        <th class="px-4 py-3">Student</th>
                                        <th class="px-4 py-3">Midterm</th>
                                        <th class="px-4 py-3">Final</th>
                                        <th class="px-4 py-3">Average</th>
                                        <th class="px-4 py-3">Letter</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    @foreach (var student in roster)
                                    {
                                        var isEditing = editingKey == $"{course.Id}_{student.StudentId}";
                                        var gradeInfo = courseGrades.GetValueOrDefault(student.StudentId);
                                        var canEditMidterm = gradeInfo == null || gradeInfo.MidtermEditCount < Grade.MaxEditCount;
                                        var canEditFinal = gradeInfo == null || gradeInfo.FinalEditCount < Grade.MaxEditCount;

                                        <tr class="@(isEditing ? "bg-indigo-50" : "") hover:bg-slate-50/70">
                                            <td class="px-4 py-3">
                                                <p class="font-semibold text-slate-900">@student.Name</p>
                                                <p class="text-xs text-slate-500">@student.DisplayId · @student.Email</p>
                                            </td>
                                            
                                            @if (isEditing)
                                            {
                                                var isViewOnly = !canEditMidterm && !canEditFinal;
                                                
                                                <!-- Editing/Viewing Mode -->
                                                <td class="px-4 py-3">
                                                    <div class="space-y-1">
                                                        <input type="number" 
                                                               @bind="editMidterm"
                                                               min="0" max="100" step="0.1"
                                                               disabled="@(!canEditMidterm)"
                                                               placeholder="0.0"
                                                               readonly="@isViewOnly"
                                                               class="w-24 rounded-lg border @(canEditMidterm ? "border-indigo-300" : "border-slate-200 bg-slate-100") px-2 py-1.5 text-sm @(isViewOnly ? "cursor-default" : "focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200")" />
                                                        @if (gradeInfo != null)
                                                        {
                                                            <p class="text-xs @GetEditCountClass(gradeInfo.MidtermEditCount)">
                                                                @gradeInfo.MidtermEditCount/2 edits
                                                            </p>
                                                        }
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="space-y-1">
                                                        <input type="number" 
                                                               @bind="editFinal"
                                                               min="0" max="100" step="0.1"
                                                               disabled="@(!canEditFinal)"
                                                               placeholder="0.0"
                                                               readonly="@isViewOnly"
                                                               class="w-24 rounded-lg border @(canEditFinal ? "border-indigo-300" : "border-slate-200 bg-slate-100") px-2 py-1.5 text-sm @(isViewOnly ? "cursor-default" : "focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200")" />
                                                        @if (gradeInfo != null)
                                                        {
                                                            <p class="text-xs @GetEditCountClass(gradeInfo.FinalEditCount)">
                                                                @gradeInfo.FinalEditCount/2 edits
                                                            </p>
                                                        }
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 font-medium text-slate-700">
                                                    @FormatScore(CalculateAverage(editMidterm, editFinal))
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="inline-flex items-center rounded-full bg-indigo-100 px-2.5 py-0.5 text-xs font-semibold text-indigo-700">
                                                        @GetLetterGrade(CalculateAverage(editMidterm, editFinal))
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    @if (isViewOnly)
                                                    {
                                                        <!-- View Only Mode - Close Button -->
                                                        <div class="flex items-center justify-end gap-2">
                                                            <span class="inline-flex items-center gap-1 rounded-full bg-rose-100 px-2.5 py-1 text-xs font-semibold text-rose-700">
                                                                <span class="bi bi-lock-fill"></span>
                                                                View Only
                                                            </span>
                                                            <button @onclick="CancelEdit"
                                                                    class="inline-flex items-center gap-1 rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 transition hover:bg-slate-50">
                                                                <span class="bi bi-x-lg"></span>
                                                                Close
                                                            </button>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <!-- Edit Mode - Save/Cancel Buttons -->
                                                        <div class="flex items-center justify-end gap-1">
                                                            <button @onclick="() => SaveGrade(course.Id, student.StudentId)" 
                                                                    disabled="@(IsInvalidScore() || (!canEditMidterm && !canEditFinal))"
                                                                    title="@GetSaveButtonTooltip(canEditMidterm, canEditFinal)"
                                                                    class="inline-flex items-center gap-1 rounded-lg bg-emerald-600 px-3 py-1.5 text-xs font-medium text-white transition hover:bg-emerald-500 disabled:cursor-not-allowed disabled:opacity-50">
                                                                <span class="bi bi-check-lg"></span>
                                                                Save
                                                            </button>
                                                            <button @onclick="CancelEdit"
                                                                    class="inline-flex items-center gap-1 rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 transition hover:bg-slate-50">
                                                                <span class="bi bi-x-lg"></span>
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    }
                                                </td>
                                            }
                                            else
                                            {
                                                <!-- Display Mode -->
                                                <td class="px-4 py-3">
                                                    <div class="space-y-1">
                                                        <p class="font-medium text-slate-700">@FormatScore(student.MidtermScore)</p>
                                                        @if (gradeInfo != null && gradeInfo.MidtermEditCount > 0)
                                                        {
                                                            <p class="text-xs @GetEditCountClass(gradeInfo.MidtermEditCount)">
                                                                @gradeInfo.MidtermEditCount/2 edits
                                                            </p>
                                                        }
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="space-y-1">
                                                        <p class="font-medium text-slate-700">@FormatScore(student.FinalScore)</p>
                                                        @if (gradeInfo != null && gradeInfo.FinalEditCount > 0)
                                                        {
                                                            <p class="text-xs @GetEditCountClass(gradeInfo.FinalEditCount)">
                                                                @gradeInfo.FinalEditCount/2 edits
                                                            </p>
                                                        }
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 font-medium text-slate-700">@FormatScore(student.AverageScore)</td>
                                                <td class="px-4 py-3">
                                                    @if (!string.IsNullOrWhiteSpace(student.LetterGrade))
                                                    {
                                                        <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-semibold text-slate-700">
                                                            @student.LetterGrade
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-slate-400">—</span>
                                                    }
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex justify-end gap-2">
                                                        @if (!canEditMidterm && !canEditFinal)
                                                        {
                                                            <!-- Max Edit Reached - View Only -->
                                                            <button @onclick="() => StartEdit(course.Id, student.StudentId, student.MidtermScore, student.FinalScore)"
                                                                    class="inline-flex items-center gap-1 rounded-lg border-2 border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-medium text-rose-700 transition hover:bg-rose-100">
                                                                <span class="bi bi-eye-fill"></span>
                                                                View Only
                                                            </button>
                                                            <span class="inline-flex items-center gap-1 rounded-full bg-rose-100 px-2.5 py-1 text-xs font-semibold text-rose-700"
                                                                  title="Maximum edit limit reached for both scores">
                                                                <span class="bi bi-lock-fill"></span>
                                                                Max Edits
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <!-- Normal Edit Button -->
                                                            <button @onclick="() => StartEdit(course.Id, student.StudentId, student.MidtermScore, student.FinalScore)"
                                                                    class="inline-flex items-center gap-1 rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-medium text-white transition hover:bg-indigo-500">
                                                                <span class="bi bi-pencil-fill"></span>
                                                                @(gradeInfo == null ? "Grade" : "Edit")
                                                            </button>
                                                        }
                                                    </div>
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </section>
            }
        </div>
    }
</div>

@code {
    // Grading state
    private string? editingKey; // Format: "courseId_studentId"
    private double? editMidterm;
    private double? editFinal;
    private Dictionary<int, Dictionary<string, Grade>> courseGradeInfo = new();

    protected override async Task AfterWorkspaceLoadedAsync()
    {
        await LoadAllGradeInfoAsync();
    }

    private async Task LoadAllGradeInfoAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        
        var courseIds = Workspace.Courses.Select(c => c.Id).ToList();
        
        var allGrades = await context.Grades
            .Where(g => courseIds.Contains(g.CourseID))
            .ToListAsync();

        courseGradeInfo.Clear();
        
        foreach (var courseId in courseIds)
        {
            var grades = allGrades
                .Where(g => g.CourseID == courseId)
                .ToDictionary(g => g.StudentID, g => g);
            
            courseGradeInfo[courseId] = grades;
        }
    }

    private void StartEdit(int courseId, string studentId, double? midterm, double? final)
    {
        editingKey = $"{courseId}_{studentId}";
        editMidterm = midterm;
        editFinal = final;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        editingKey = null;
        editMidterm = null;
        editFinal = null;
        StateHasChanged();
    }

    private async Task SaveGrade(int courseId, string studentId)
    {
        using var context = await DbFactory.CreateDbContextAsync();
        
        Grade? grade;
        bool isNew = false;

        // Find or create grade
        grade = await context.Grades
            .FirstOrDefaultAsync(g => g.StudentID == studentId && g.CourseID == courseId);

        if (grade == null)
        {
            grade = new Grade
            {
                StudentID = studentId,
                CourseID = courseId
            };
            isNew = true;
        }

        // Validate and update Midterm
        if (editMidterm.HasValue)
        {
            if (editMidterm.Value < 0 || editMidterm.Value > 100)
            {
                Toasts.Enqueue("Midterm score must be between 0 and 100", ToastType.Error);
                return;
            }

            if (grade.MidtermEditCount >= Grade.MaxEditCount && grade.MidtermScore != editMidterm.Value)
            {
                Toasts.Enqueue($"Midterm score has reached maximum edit limit ({Grade.MaxEditCount} times)", ToastType.Error);
                return;
            }

            if (grade.MidtermScore != editMidterm.Value)
            {
                grade.MidtermScore = editMidterm.Value;
                if (!isNew) grade.MidtermEditCount++;
            }
        }

        // Validate and update Final
        if (editFinal.HasValue)
        {
            if (editFinal.Value < 0 || editFinal.Value > 100)
            {
                Toasts.Enqueue("Final score must be between 0 and 100", ToastType.Error);
                return;
            }

            if (grade.FinalEditCount >= Grade.MaxEditCount && grade.FinalScore != editFinal.Value)
            {
                Toasts.Enqueue($"Final score has reached maximum edit limit ({Grade.MaxEditCount} times)", ToastType.Error);
                return;
            }

            if (grade.FinalScore != editFinal.Value)
            {
                grade.FinalScore = editFinal.Value;
                if (!isNew) grade.FinalEditCount++;
            }
        }

        // Calculate average and letter grade
        grade.CalculateGrade();

        if (isNew)
        {
            context.Grades.Add(grade);
        }

        await context.SaveChangesAsync();
        
        Toasts.Enqueue("Grade saved successfully", ToastType.Success);
        
        // Reload data
        await OnInitializedAsync();
        
        CancelEdit();
    }

    private static string FormatScore(double? score)
        => score.HasValue ? score.Value.ToString("0.0") : "—";

    private static double? CalculateAverage(double? midterm, double? final)
    {
        if (midterm.HasValue && final.HasValue)
        {
            return (midterm.Value * 0.4) + (final.Value * 0.6);
        }
        return null;
    }

    private static string GetLetterGrade(double? average)
    {
        if (!average.HasValue) return "—";
        if (average >= 80) return "D";
        if (average >= 65) return "M";
        if (average >= 50) return "P";
        return "F";
    }

    private static string GetEditCountClass(int editCount)
    {
        return editCount switch
        {
            0 => "text-slate-500",
            1 => "text-amber-600 font-medium",
            >= 2 => "text-rose-600 font-semibold",
            _ => "text-slate-500"
        };
    }

    private bool IsInvalidScore()
    {
        // Check if either score is out of valid range
        if (editMidterm.HasValue && (editMidterm.Value < 0 || editMidterm.Value > 100))
            return true;
        
        if (editFinal.HasValue && (editFinal.Value < 0 || editFinal.Value > 100))
            return true;
        
        return false;
    }

    private string GetSaveButtonTooltip(bool canEditMidterm, bool canEditFinal)
    {
        if (IsInvalidScore())
            return "Scores must be between 0 and 100";
        
        if (!canEditMidterm && !canEditFinal)
            return "Both scores have reached maximum edit limit (2 times)";
        
        return "Click to save grades";
    }
}
