@page "/admin/timetable/edit"
@attribute [Authorize(Roles = "Admin")]
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using FinalAssignemnt_APDP.Data
@using FinalAssignemnt_APDP.Constants
@using FinalAssignemnt_APDP.Services
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject TimetableService Timetable
@inject NavigationManager NavigationManager
@inject FinalAssignemnt_APDP.Services.ToastQueue Toasts

<PageTitle>Timetable Slot</PageTitle>

@if (isLoading)
{
    <div class="container py-5 text-center">
        <div class="spinner-border" role="status"></div>
        <p class="mt-3 text-muted">Loading...</p>
    </div>
}
else
{
    <div class="container py-4">
        <a class="btn btn-link px-0" href="@AppRoutes.AdminTimetable"><i class="bi bi-arrow-left"></i> Back to timetable</a>
        <h1 class="fw-bold mt-2">@(form.Id == Guid.Empty ? "Create Slot" : "Edit Slot")</h1>
        <p class="text-muted">Define the session details shown on the weekly grid.</p>

        <EditForm Model="form" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="card border-0 shadow-sm">
                <div class="card-body row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Title<span class="text-danger">*</span></label>
                        <InputText class="form-control" @bind-Value="form.Title" />
                        <ValidationMessage For="() => form.Title" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Course (optional)</label>
                        <InputSelect class="form-select" @bind-Value="form.CourseId">
                            <option value="">Unlinked</option>
                            @foreach (var course in courseOptions)
                            {
                                <option value="@course.Id">@course.Label</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Day</label>
                        <InputSelect class="form-select" @bind-Value="form.Day">
                            @foreach (var day in Enum.GetValues<DayOfWeek>())
                            {
                                <option value="@day">@day</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Start</label>
                        <InputText type="time" class="form-control" @bind-Value="form.Start" />
                        <ValidationMessage For="() => form.Start" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">End</label>
                        <InputText type="time" class="form-control" @bind-Value="form.End" />
                        <ValidationMessage For="() => form.End" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Room</label>
                        <InputText class="form-control" @bind-Value="form.Room" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Lecturer</label>
                        <InputText class="form-control" @bind-Value="form.Lecturer" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Notes</label>
                        <InputText class="form-control" @bind-Value="form.Notes" />
                    </div>
                    @if (!string.IsNullOrEmpty(timeError))
                    {
                        <div class="col-12">
                            <div class="alert alert-warning py-2">@timeError</div>
                        </div>
                    }
                </div>
                <div class="card-footer bg-white text-end">
                    <button type="button" class="btn btn-outline-secondary me-2" @onclick="() => NavigationManager.NavigateTo(AppRoutes.AdminTimetable)">Cancel</button>
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" hidden="@(!isSaving)"></span>
                        Save
                    </button>
                </div>
            </div>
        </EditForm>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    public Guid? id { get; set; }

    private readonly TimetableForm form = new();
    private readonly List<CourseOption> courseOptions = new();
    private bool isLoading = true;
    private bool isSaving;
    private string? timeError;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        var courses = await context.Courses
            .Include(c => c.Subject)
            .Include(c => c.Semester)
            .OrderBy(c => c.Name)
            .Select(c => new CourseOption
            {
                Id = c.Id.ToString(),
                Label = c.Subject != null && c.Semester != null
                    ? $"{c.Name} ({c.Subject.Name} - {c.Semester.Name})"
                    : c.Subject != null
                        ? $"{c.Name} ({c.Subject.Name})"
                        : c.Semester != null
                            ? $"{c.Name} ({c.Semester.Name})"
                            : c.Name
            }).ToListAsync();
        courseOptions.AddRange(courses);

        if (id.HasValue)
        {
            var slot = await Timetable.GetAsync(id.Value);
            if (slot is not null)
            {
                form.Id = slot.Id;
                form.Title = slot.Title;
                form.CourseId = slot.CourseId?.ToString();
                form.Day = slot.DayOfWeek;
                form.Start = slot.StartTime.ToString(@"hh\:mm");
                form.End = slot.EndTime.ToString(@"hh\:mm");
                form.Room = slot.Room;
                form.Lecturer = slot.Lecturer;
                form.Notes = slot.Notes;
            }
        }

        isLoading = false;
    }

    private async Task SaveAsync()
    {
        if (isSaving)
        {
            return;
        }

        timeError = null;
        if (!TimeSpan.TryParse(form.Start, out var start))
        {
            timeError = "Invalid start time";
            return;
        }
        if (!TimeSpan.TryParse(form.End, out var end))
        {
            timeError = "Invalid end time";
            return;
        }
        if (end <= start)
        {
            timeError = "End time must be after start time.";
            return;
        }

        isSaving = true;
        var slot = new TimetableSlot
        {
            Id = form.Id,
            Title = form.Title!,
            CourseId = string.IsNullOrWhiteSpace(form.CourseId) ? null : int.Parse(form.CourseId),
            DayOfWeek = form.Day,
            StartTime = start,
            EndTime = end,
            Room = form.Room ?? string.Empty,
            Lecturer = form.Lecturer ?? string.Empty,
            Notes = form.Notes
        };

        await Timetable.SaveAsync(slot);
        Toasts.Enqueue("Timetable saved", FinalAssignemnt_APDP.Services.ToastType.Success);
        NavigationManager.NavigateTo(AppRoutes.AdminTimetable);
    }

    private sealed class TimetableForm
    {
        public Guid Id { get; set; } = Guid.Empty;

        [Required]
        public string? Title { get; set; }

        public string? CourseId { get; set; }

        public DayOfWeek Day { get; set; } = DayOfWeek.Monday;

        [Required]
        public string Start { get; set; } = "08:00";

        [Required]
        public string End { get; set; } = "09:00";

        public string? Room { get; set; }
        public string? Lecturer { get; set; }
        public string? Notes { get; set; }
    }

    private sealed class CourseOption
    {
        public string Id { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
    }
}
