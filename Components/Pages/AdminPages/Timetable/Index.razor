@page "/admin/timetable"
@attribute [Authorize(Roles = "Admin")]
@using FinalAssignemnt_APDP.Services
@using FinalAssignemnt_APDP.Constants
@inject TimetableService Timetable
@inject NavigationManager NavigationManager
@inject FinalAssignemnt_APDP.Services.ToastQueue Toasts

<PageTitle>Timetable</PageTitle>

<div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <p class="text-uppercase text-muted small mb-1">Scheduling</p>
            <h1 class="fw-bold mb-0">Weekly Timetable</h1>
            <small class="text-muted">Share slots with lecturers and students.</small>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" @onclick="LoadSlots"><i class="bi bi-arrow-clockwise"></i></button>
            <a class="btn btn-primary" href="@AppRoutes.AdminTimetableNew"><i class="bi bi-plus-circle"></i> New Slot</a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-3 text-muted">Loading timetable...</p>
        </div>
    }
    else if (!dayGroups.Any())
    {
        <div class="alert alert-info">No timetable entries yet. Create the first slot.</div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var dayGroup in dayGroups)
            {
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light fw-semibold">@dayGroup.Label</div>
                        <div class="list-group list-group-flush">
                            @foreach (var slot in dayGroup.Slots)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <div class="fw-semibold">@slot.Title</div>
                                            <small class="text-muted">@slot.StartTime.ToString(@"hh\:mm") - @slot.EndTime.ToString(@"hh\:mm") @if (!string.IsNullOrWhiteSpace(slot.Room)) { <span>| Room @slot.Room</span>; }</small>
                                            @if (!string.IsNullOrWhiteSpace(slot.Lecturer))
                                            {
                                                <div class="small text-muted">@slot.Lecturer</div>
                                            }
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <a class="btn btn-outline-primary" href="@AppRoutes.AdminTimetableEdit(slot.Id)"><i class="bi bi-pencil"></i></a>
                                            <button class="btn btn-outline-danger" @onclick="() => ConfirmDelete(slot.Id)"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(slot.Notes))
                                    {
                                        <div class="mt-2 small text-muted">@slot.Notes</div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private readonly List<DayGroup> dayGroups = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSlots();
    }

    private async Task LoadSlots()
    {
        isLoading = true;
        dayGroups.Clear();
        var slots = (await Timetable.GetAllAsync())
            .OrderBy(slot => slot.DayOfWeek)
            .ThenBy(slot => slot.StartTime)
            .ToList();
        foreach (var group in slots.GroupBy(s => s.DayOfWeek))
        {
            dayGroups.Add(new DayGroup
            {
                Label = group.Key.ToString(),
                Slots = group.OrderBy(s => s.StartTime).ToList()
            });
        }
        isLoading = false;
    }

    private async Task ConfirmDelete(Guid id)
    {
        await Timetable.DeleteAsync(id);
        Toasts.Enqueue("Slot removed", FinalAssignemnt_APDP.Services.ToastType.Success);
        await LoadSlots();
    }

    private sealed class DayGroup
    {
        public string Label { get; set; } = string.Empty;
        public List<TimetableSlot> Slots { get; set; } = new();
    }
}
