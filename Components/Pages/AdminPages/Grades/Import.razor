@page "/admin/grades/import"
@attribute [Authorize(Roles = "Admin,Lecturer")]
@using System.Text
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using FinalAssignemnt_APDP.Data
@using FinalAssignemnt_APDP.Constants
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject FinalAssignemnt_APDP.Services.ToastQueue Toasts
@inject NavigationManager NavigationManager

<PageTitle>Import Grades</PageTitle>

<div class="container py-4">
    <a class="btn btn-link px-0" href="@AppRoutes.AdminGrades"><i class="bi bi-arrow-left"></i> Back to grade list</a>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="fw-bold">Template</h5>
                    <p class="text-muted">Use CSV file with the following columns:</p>
                    <code class="d-block bg-light p-2 rounded small">StudentId,CourseId,Midterm,Final,Note</code>
                    <p class="text-muted mt-3 small">Download current data as reference:</p>
                    <a class="btn btn-outline-secondary w-100" href="/api/grades/export"><i class="bi bi-download"></i> Download CSV</a>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="fw-bold">Upload</h5>
                    <p class="text-muted">Existing rows (Student + Course) will be updated, new rows will be created.</p>
                    <InputFile OnChange="OnFileChange" accept=".csv" />
                    <div class="form-text">Max size: 1 MB</div>
                </div>
                <div class="card-footer bg-white text-end">
                    <button class="btn btn-primary" @onclick="ProcessFile" disabled="@(!canProcess || isProcessing)">
                        <span class="spinner-border spinner-border-sm me-2" role="status" hidden="@(!isProcessing)"></span>
                        Import
                    </button>
                </div>
            </div>

            @if (results.Any())
            {
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body">
                        <h6 class="fw-bold">Summary</h6>
                        <ul class="list-inline mb-3">
                            <li class="list-inline-item"><span class="badge bg-success">Inserted: @results.Count(r => r.Status == ImportStatus.Inserted)</span></li>
                            <li class="list-inline-item"><span class="badge bg-info text-dark">Updated: @results.Count(r => r.Status == ImportStatus.Updated)</span></li>
                            <li class="list-inline-item"><span class="badge bg-danger">Failed: @results.Count(r => r.Status == ImportStatus.Failed)</span></li>
                        </ul>
                        <div class="table-responsive" style="max-height: 320px;">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Course</th>
                                        <th>Status</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var row in results)
                                    {
                                        <tr>
                                            <td>@row.StudentId</td>
                                            <td>@row.CourseId</td>
                                            <td>
                                                @if (row.Status == ImportStatus.Inserted)
                                                {
                                                    <span class="badge bg-success">Inserted</span>
                                                }
                                                else if (row.Status == ImportStatus.Updated)
                                                {
                                                    <span class="badge bg-info text-dark">Updated</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Failed</span>
                                                }
                                            </td>
                                            <td>@row.Message</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private IBrowserFile? file;
    private bool canProcess => file is not null;
    private bool isProcessing;
    private readonly List<ImportResult> results = new();

    private void OnFileChange(InputFileChangeEventArgs args)
    {
        file = args.File;
        results.Clear();
    }

    private async Task ProcessFile()
    {
        if (file is null || isProcessing)
        {
            return;
        }

        isProcessing = true;
        results.Clear();
        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            using var stream = file.OpenReadStream(1_000_000);
            using var reader = new StreamReader(stream, Encoding.UTF8);
            var lineNumber = 0;
            while (!reader.EndOfStream)
            {
                var line = await reader.ReadLineAsync();
                if (line is null)
                {
                    break;
                }
                lineNumber++;
                if (string.IsNullOrWhiteSpace(line))
                {
                    continue;
                }
                if (lineNumber == 1 && line.StartsWith("StudentId", StringComparison.OrdinalIgnoreCase))
                {
                    continue; // header
                }

                var cells = line.Split(',');
                var studentId = cells.ElementAtOrDefault(0)?.Trim() ?? string.Empty;
                var courseCell = cells.ElementAtOrDefault(1)?.Trim() ?? string.Empty;
                if (cells.Length < 4)
                {
                    results.Add(new ImportResult(studentId, courseCell, ImportStatus.Failed, "Expected 4+ columns"));
                    continue;
                }

                if (!int.TryParse(courseCell, out var courseId))
                {
                    results.Add(new ImportResult(studentId, courseCell, ImportStatus.Failed, "CourseId is not a number"));
                    continue;
                }
                double? midterm = TryParseDouble(cells.ElementAtOrDefault(2));
                double? final = TryParseDouble(cells.ElementAtOrDefault(3));
                var note = cells.ElementAtOrDefault(4)?.Trim();

                try
                {
                    var entity = await context.Grades.FirstOrDefaultAsync(g => g.StudentID == studentId && g.CourseID == courseId);
                    var isNew = entity is null;
                    if (isNew)
                    {
                        entity = new Grade { StudentID = studentId, CourseID = courseId };
                        context.Grades.Add(entity);
                    }
                    entity!.MidtermScore = midterm;
                    entity.FinalScore = final;
                    entity.Note = note;
                    entity.CalculateGrade();
                    await context.SaveChangesAsync();
                    results.Add(new ImportResult(studentId, courseCell, isNew ? ImportStatus.Inserted : ImportStatus.Updated, "OK"));
                }
                catch (Exception ex)
                {
                    results.Add(new ImportResult(studentId, courseCell, ImportStatus.Failed, ex.Message));
                }
            }

            Toasts.Enqueue("Import finished", FinalAssignemnt_APDP.Services.ToastType.Success);
        }
        catch (Exception ex)
        {
            Toasts.Enqueue($"Import failed: {ex.Message}", FinalAssignemnt_APDP.Services.ToastType.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private static double? TryParseDouble(string? value)
    {
        if (double.TryParse(value, out var result))
        {
            return result;
        }
        return null;
    }

    private sealed record ImportResult(string StudentId, string CourseId, ImportStatus Status, string Message);

    private enum ImportStatus
    {
        Inserted,
        Updated,
        Failed
    }
}
