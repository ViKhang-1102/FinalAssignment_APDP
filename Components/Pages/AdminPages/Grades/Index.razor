@page "/admin/grades"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Lecturer")]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using System.Linq
@using FinalAssignemnt_APDP.Data
@using FinalAssignemnt_APDP.Constants
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>Grade Workspace</PageTitle>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <p class="text-xs font-semibold tracking-widest text-slate-500 uppercase">Scores</p>
            <h1 class="text-3xl font-bold text-slate-900">Grade Management</h1>
            <p class="text-sm text-slate-500">Import/export CSV or maintain individual student grades.</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <a href="@AppRoutes.AdminGradesImport" class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow transition hover:-translate-y-0.5 hover:border-slate-300">
                <i class="bi bi-upload"></i> Import CSV
            </a>
            <a href="/api/grades/export" class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow transition hover:-translate-y-0.5 hover:border-slate-300">
                <i class="bi bi-download"></i> Export CSV
            </a>
            
        </div>
    </div>

    @if (isLoading)
    {
        <div class="rounded-xl border border-dashed border-slate-300 bg-white/60 p-12 text-center text-slate-600">
            <div class="spinner-border text-indigo-600" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-slate-600">Loading grades...</p>
        </div>
    }
    else if (!gradeRows.Any())
    {
        <div class="rounded-xl border border-dashed border-slate-300 bg-white/60 p-12 text-center text-slate-600">
            <i class="bi bi-inbox text-4xl text-slate-400"></i>
            <p class="mt-2">No grade records match the current filter.</p>
        </div>
    }
    else
    {
        <div class="overflow-hidden rounded-xl bg-white shadow-sm">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50">
                        <tr class="text-left text-xs font-semibold uppercase tracking-wider text-slate-600">
                            <th class="px-6 py-3">Student</th>
                            <th class="px-6 py-3">Course</th>
                            <th class="px-6 py-3">Semester</th>
                            <th class="px-6 py-3">Midterm</th>
                            <th class="px-6 py-3">Final</th>
                            <th class="px-6 py-3">Average</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">Letter</th>
                            <th class="px-6 py-3">Uploaded File</th>
                            <th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 bg-white">
                        @{
                            var pageItems = gradeRows.Skip(currentPage * itemsPerPage).Take(itemsPerPage);
                        }
                        @foreach (var row in pageItems)
                        {
                            <tr class="hover:bg-slate-50">
                                <td class="px-6 py-4 font-medium text-slate-900">@row.Student</td>
                                <td class="px-6 py-4 text-slate-700">@row.Course</td>
                                <td class="px-6 py-4 text-slate-700">@row.Semester</td>
                                <td class="px-6 py-4 text-slate-700">@(row.Midterm?.ToString("F1") ?? "-")</td>
                                <td class="px-6 py-4 text-slate-700">@(row.Final?.ToString("F1") ?? "-")</td>
                                <td class="px-6 py-4 text-slate-700">@(row.Average?.ToString("F1") ?? "-")</td>
                                <td class="px-6 py-4">
                                    @if (row.IsPassed)
                                    {
                                        <span class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-700">Passed</span>
                                    }
                                    else
                                    {
                                        <span class="inline-flex items-center rounded-full bg-rose-100 px-2.5 py-0.5 text-xs font-semibold text-rose-700">Failed</span>
                                    }
                                </td>
                                <td class="px-6 py-4 text-slate-700">@row.Letter</td>
                                <td class="px-6 py-4">
                                    @if (!string.IsNullOrWhiteSpace(row.UploadedFileName))
                                    {
                                        <div class="flex items-center gap-2">
                                            <i class="bi bi-file-earmark-text text-indigo-600"></i>
                                            <div class="text-xs">
                                                <div class="font-semibold text-slate-700 truncate max-w-[150px]" title="@row.UploadedFileName">
                                                    @row.UploadedFileName
                                                </div>
                                                @if (row.UploadedFileDate.HasValue)
                                                {
                                                    <div class="text-slate-500">@row.UploadedFileDate.Value.ToLocalTime().ToString("MM/dd/yyyy HH:mm")</div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-slate-400 text-xs">No file</span>
                                    }
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center justify-end gap-2">
                                        <a href="@AppRoutes.AdminGradesDelete(row.Id)" class="inline-flex items-center rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600 transition hover:bg-rose-50" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        
        @if (gradeRows.Count > itemsPerPage)
        {
            <div class="mt-4 flex items-center justify-between rounded-lg bg-white px-4 py-3 shadow-sm">
                <div class="text-sm text-slate-600">
                    Showing @((currentPage * itemsPerPage) + 1) to @Math.Min((currentPage + 1) * itemsPerPage, gradeRows.Count) of @gradeRows.Count results
                </div>
                <div class="flex gap-2">
                    <button @onclick="() => currentPage = Math.Max(0, currentPage - 1)" 
                            disabled="@(currentPage == 0)"
                            class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <span class="inline-flex items-center px-4 text-sm text-slate-700">
                        Page @(currentPage + 1) of @((int)Math.Ceiling((double)gradeRows.Count / itemsPerPage))
                    </span>
                    <button @onclick="() => currentPage = Math.Min(((gradeRows.Count - 1) / itemsPerPage), currentPage + 1)" 
                            disabled="@(currentPage >= ((gradeRows.Count - 1) / itemsPerPage))"
                            class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        }
    }
</div>

@code {
    private readonly List<GradeView> gradeRows = new();
    private readonly List<CourseOption> courses = new();
    private string? selectedCourseId;
    private string studentSearch = string.Empty;
    private string statusFilter = string.Empty;
    private bool isLoading;
    private int currentPage = 0;
    private int itemsPerPage = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        gradeRows.Clear();
        courses.Clear();

        using var context = await DbFactory.CreateDbContextAsync();

        var courseList = await context.Courses
            .Include(c => c.Subject)
            .Include(c => c.Semester)
            .OrderBy(c => c.Name)
            .ToListAsync();

        courses.AddRange(courseList.Select(c => new CourseOption
        {
            Id = c.Id,
            Name = c.Name,
            SubjectName = c.Subject?.Name ?? "",
            SemesterName = c.Semester?.Name ?? ""
        }));

        var query = context.Grades
            .Include(g => g.Course).ThenInclude(c => c.Semester)
            .Include(g => g.Course).ThenInclude(c => c.Subject)
            .Include(g => g.Student)
            .AsQueryable();

        if (!string.IsNullOrWhiteSpace(studentSearch))
        {
            query = query.Where(g => 
                (g.Student != null && g.Student.StudentId != null && g.Student.StudentId.Contains(studentSearch)) ||
                (g.Student != null && g.Student.Name != null && g.Student.Name.Contains(studentSearch)));
        }

        if (int.TryParse(selectedCourseId, out var courseId))
        {
            query = query.Where(g => g.CourseID == courseId);
        }

        if (statusFilter == "Passed")
        {
            query = query.Where(g => g.IsPassed);
        }
        else if (statusFilter == "Failed")
        {
            query = query.Where(g => !g.IsPassed);
        }

        var data = await query.OrderByDescending(g => g.Id).ToListAsync();
        foreach (var grade in data)
        {
            gradeRows.Add(new GradeView
            {
                Id = grade.Id,
                Student = !string.IsNullOrWhiteSpace(grade.Student?.StudentId) 
                    ? $"{grade.Student.StudentId} - {grade.Student.Name}" 
                    : (grade.Student?.Name ?? "Unknown Student"),
                Course = grade.Course?.Name ?? $"Course #{grade.CourseID}",
                Semester = grade.Course?.Semester?.Name ?? "-",
                Midterm = grade.MidtermScore,
                Final = grade.FinalScore,
                Average = grade.AverageScore,
                Letter = grade.LetterGrade,
                IsPassed = grade.IsPassed,
                UploadedFileName = grade.UploadedFileName,
                UploadedFileDate = grade.UploadedFileDate,
                UploadedFileStoredPath = grade.UploadedFileStoredPath
            });
        }

        isLoading = false;
    }

    private async Task ResetFilters()
    {
        studentSearch = string.Empty;
        selectedCourseId = string.Empty;
        statusFilter = string.Empty;
        currentPage = 0;
        await LoadData();
    }

    private async Task OnStudentSearchChanged(ChangeEventArgs args)
    {
        studentSearch = args.Value?.ToString() ?? string.Empty;
        currentPage = 0;
        await LoadData();
    }

    private async Task OnCourseChanged(ChangeEventArgs args)
    {
        selectedCourseId = args.Value?.ToString();
        currentPage = 0;
        await LoadData();
    }

    private async Task OnStatusChanged(ChangeEventArgs args)
    {
        statusFilter = args.Value?.ToString() ?? string.Empty;
        currentPage = 0;
        await LoadData();
    }

    private sealed class GradeView
    {
        public int Id { get; set; }
        public string Student { get; set; } = string.Empty;
        public string Course { get; set; } = string.Empty;
        public string Semester { get; set; } = string.Empty;
        public double? Midterm { get; set; }
        public double? Final { get; set; }
        public double? Average { get; set; }
        public string? Letter { get; set; }
        public bool IsPassed { get; set; }
        public string? UploadedFileName { get; set; }
        public DateTime? UploadedFileDate { get; set; }
        public string? UploadedFileStoredPath { get; set; }
    }

    private sealed class CourseOption
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string SubjectName { get; set; } = string.Empty;
        public string SemesterName { get; set; } = string.Empty;
    }
}
