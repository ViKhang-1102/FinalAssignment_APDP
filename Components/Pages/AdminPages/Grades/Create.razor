@page "/admin/grades/create"
@attribute [Authorize(Roles = "Admin,Lecturer")]
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using FinalAssignemnt_APDP.Data
@using FinalAssignemnt_APDP.Constants
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject FinalAssignemnt_APDP.Services.ToastQueue Toasts

<PageTitle>New Grade</PageTitle>

<div class="container py-4">
    <div class="mb-4">
        <a class="btn btn-link px-0" href="@AppRoutes.AdminGrades"><i class="bi bi-arrow-left"></i> Back to grade list</a>
        <h1 class="fw-bold mt-2">Create Grade</h1>
        <p class="text-muted">Link a student to a course and capture their scores.</p>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-3 text-muted">Loading students and courses...</p>
        </div>
    }
    else
    {
        <EditForm Model="grade" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="card border-0 shadow-sm">
                <div class="card-body row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Student<span class="text-danger">*</span></label>
                        <InputSelect class="form-select" @bind-Value="grade.StudentId">
                            <option value="">Select a student</option>
                            @foreach (var student in students)
                            {
                                <option value="@student.Id">@student.Label</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => grade.StudentId" class="text-danger" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Course<span class="text-danger">*</span></label>
                        <InputSelect class="form-select" @bind-Value="grade.CourseId">
                            <option value="">Select a course</option>
                            @foreach (var course in courses)
                            {
                                <option value="@course.Id">@course.Label</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => grade.CourseId" class="text-danger" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Midterm (0-100)</label>
                        <InputNumber class="form-control" @bind-Value="grade.Midterm" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Final (0-100)</label>
                        <InputNumber class="form-control" @bind-Value="grade.Final" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Notes</label>
                        <InputText class="form-control" @bind-Value="grade.Note" />
                    </div>
                </div>
                <div class="card-footer bg-white text-end">
                    <button class="btn btn-outline-secondary me-2" type="button" @onclick="() => NavigationManager.NavigateTo(AppRoutes.AdminGrades)">Cancel</button>
                    <button class="btn btn-primary" type="submit" disabled="@isSaving">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" hidden="@(!isSaving)"></span>
                        Save
                    </button>
                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    private readonly GradeInput grade = new();
    private readonly List<SelectOption> students = new();
    private readonly List<SelectOption> courses = new();
    private bool isLoading = true;
    private bool isSaving;

    protected override async Task OnInitializedAsync()
    {
        await LoadSelections();
    }

    private async Task LoadSelections()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        var studentList = await context.Users
            .OrderBy(u => u.Name)
            .Select(u => new SelectOption { Id = u.Id, Label = string.IsNullOrWhiteSpace(u.Name) ? u.Email! : u.Name! })
            .ToListAsync();
        var courseList = await context.Courses
            .Include(c => c.Subject)
            .Include(c => c.Semester)
            .OrderBy(c => c.Name)
            .Select(c => new SelectOption
            {
                Id = c.Id.ToString(),
                Label = c.Subject != null && c.Semester != null
                    ? $"{c.Name} ({c.Subject.Name} - {c.Semester.Name})"
                    : c.Subject != null
                        ? $"{c.Name} ({c.Subject.Name})"
                        : c.Semester != null
                            ? $"{c.Name} ({c.Semester.Name})"
                            : c.Name
            }).ToListAsync();

        students.Clear();
        students.AddRange(studentList);
        courses.Clear();
        courses.AddRange(courseList);
        isLoading = false;
    }

    private async Task SaveAsync()
    {
        if (isSaving)
        {
            return;
        }

        isSaving = true;
        using var context = await DbFactory.CreateDbContextAsync();
        var entity = new Grade
        {
            StudentID = grade.StudentId!,
            CourseID = int.Parse(grade.CourseId!),
            MidtermScore = grade.Midterm,
            FinalScore = grade.Final,
            Note = grade.Note
        };
        entity.CalculateGrade();
        context.Grades.Add(entity);
        await context.SaveChangesAsync();
        Toasts.Enqueue("Grade created", FinalAssignemnt_APDP.Services.ToastType.Success);
        NavigationManager.NavigateTo(AppRoutes.AdminGrades);
    }

    private sealed class SelectOption
    {
        public string Id { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
    }

    private sealed class GradeInput
    {
        [Required]
        public string? StudentId { get; set; }

        [Required]
        public string? CourseId { get; set; }

        [Range(0, 100)]
        public double? Midterm { get; set; }

        [Range(0, 100)]
        public double? Final { get; set; }

        [StringLength(250)]
        public string? Note { get; set; }
    }
}
