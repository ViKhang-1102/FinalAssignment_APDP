@page "/users/create"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using FinalAssignemnt_APDP.Data
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavigationManager

<PageTitle>Create User</PageTitle>

<div class="container py-5 fade-in">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-primary mb-0">
                        <i class="bi bi-person-plus-fill me-2"></i>Create New User
                    </h2>
                    <p class="text-muted mb-0">Register a new student or staff member.</p>
                </div>
                <a href="/users" class="btn btn-outline-secondary rounded-pill px-3">
                    <i class="bi bi-arrow-left me-1"></i> Back
                </a>
            </div>

            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-4 p-md-5">

                    <EditForm Model="Input" OnValidSubmit="CreateUser" FormName="create-user" method="post" Enhance>
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <ValidationSummary class="text-danger alert alert-danger border-0 bg-soft-danger" role="alert" />
                        </div>

                        <div class="row g-3">
                            <div class="col-12 mb-2">
                                <label class="form-label fw-bold text-secondary">
                                    <i class="bi bi-envelope-fill me-1"></i>Email Address
                                </label>
                                <InputText @bind-Value="Input.Email" class="form-control form-control-lg" placeholder="name@example.com" />
                                <ValidationMessage For="() => Input.Email" class="text-danger small mt-1" />
                            </div>

                            <div class="col-12 mb-2">
                                <label class="form-label fw-bold text-secondary">
                                    <i class="bi bi-key-fill me-1"></i>Password
                                </label>
                                <InputText type="password" @bind-Value="Input.Password" class="form-control form-control-lg" placeholder="Create a strong password" />
                                <ValidationMessage For="() => Input.Password" class="text-danger small mt-1" />
                            </div>

                            <div class="col-12 mb-2">
                                <label class="form-label fw-bold text-secondary">
                                    <i class="bi bi-person-badge-fill me-1"></i>Full Name
                                </label>
                                <InputText @bind-Value="Input.Name" class="form-control form-control-lg" placeholder="e.g. Nguyen Van A" />
                            </div>

                            <div class="col-md-6 mb-2">
                                <label class="form-label fw-bold text-secondary">
                                    <i class="bi bi-card-heading me-1"></i>Student ID
                                </label>
                                <InputText @bind-Value="Input.StudentId" class="form-control form-control-lg font-monospace" placeholder="e.g. 21000123" />
                            </div>

                            <div class="col-md-6 mb-2">
                                <label class="form-label fw-bold text-secondary">
                                    <i class="bi bi-person-gear me-1"></i>System Role
                                </label>
                                <InputSelect @bind-Value="Input.Role" class="form-select form-select-lg">
                                    <option value="">-- Select role --</option>
                                    @foreach (var r in Roles)
                                    {
                                        <option value="@r">@r</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="/users" class="btn btn-light btn-lg px-4 rounded-pill">Cancel</a>

                            <button type="submit" class="btn btn-gradient-primary btn-lg px-4 rounded-pill shadow-sm">
                                <i class="bi bi-check-lg me-2"></i>Create User
                            </button>
                        </div>

                    </EditForm>
                </div>
            </div>

        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private CreateInput Input { get; set; } = new();

    private List<string> Roles { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        Roles = await RoleManager.Roles.Select(r => r.Name!).ToListAsync();
    }

    private async Task CreateUser()
    {
        var user = new ApplicationUser { UserName = Input.Email, Email = Input.Email, Name = Input.Name, StudentId = Input.StudentId };
        var result = await UserManager.CreateAsync(user, Input.Password);
        if (!result.Succeeded)
        {
            return;
        }
        if (!string.IsNullOrEmpty(Input.Role))
        {
            await UserManager.AddToRoleAsync(user, Input.Role);
        }
        NavigationManager.NavigateTo("/users");
    }

    private class CreateInput
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
        [Required]
        public string Password { get; set; } = "";
        public string Name { get; set; } = "";
        public string StudentId { get; set; } = "";
        public string Role { get; set; } = "";
    }
}
