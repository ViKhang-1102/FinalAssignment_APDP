@page "/test-import"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms

<h3>Test File Upload</h3>

<div class="mb-3">
    <label>Select File:</label>
    <InputFile OnChange="OnFileSelected" accept=".csv,.xlsx" class="form-control" />
</div>

@if (selectedFile != null)
{
    <div class="alert alert-info">
        <p><strong>File Selected:</strong> @selectedFile.Name</p>
        <p><strong>Size:</strong> @selectedFile.Size bytes</p>
        <p><strong>Content Type:</strong> @selectedFile.ContentType</p>
    </div>
    
    <button class="btn btn-primary" @onclick="TestRead">Test Read File</button>
}

@if (!string.IsNullOrEmpty(testResult))
{
    <div class="alert alert-success mt-3">
        <h5>Test Result:</h5>
        <pre>@testResult</pre>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-3">
        <h5>Error:</h5>
        <p>@errorMessage</p>
    </div>
}

@code {
    private IBrowserFile? selectedFile;
    private string? testResult;
    private string? errorMessage;

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        testResult = null;
        errorMessage = null;
        Console.WriteLine($"File selected: {selectedFile.Name}");
    }

    private async Task TestRead()
    {
        if (selectedFile == null) return;

        try
        {
            Console.WriteLine("=== Starting file read test ===");
            
            using var stream = selectedFile.OpenReadStream(5_000_000);
            using var reader = new StreamReader(stream);
            
            // ? FIX: Use async ReadLineAsync
            var firstLine = await reader.ReadLineAsync();
            var secondLine = await reader.ReadLineAsync();
            
            testResult = $"First line: {firstLine}\nSecond line: {secondLine}";
            
            Console.WriteLine("=== File read successful ===");
            Console.WriteLine(testResult);
        }
        catch (Exception ex)
        {
            errorMessage = $"{ex.GetType().Name}: {ex.Message}\n\nStack Trace:\n{ex.StackTrace}";
            Console.WriteLine("=== ERROR ===");
            Console.WriteLine(errorMessage);
        }
    }
}
