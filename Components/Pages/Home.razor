@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using FinalAssignemnt_APDP.Constants
@inject NavigationManager NavigationManager

<PageTitle>SIMS Portal</PageTitle>

<div class="container py-5 fade-in">
    <AuthorizeView>
        <NotAuthorized>
            <div class="position-relative w-100 vh-100 d-flex align-items-center justify-content-center text-white overflow-hidden p-0">
                <div class="col-lg-8 text-center">
                    <div class="mb-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-white text-primary rounded-circle p-4 shadow-lg mb-4" style="width: 120px; height: 120px;">
                            <i class="bi bi-grid-1x2-fill display-3"></i>
                        </div>
                    </div>
                    <h1 class="display-4 fw-bold text-dark mb-3">Welcome to SIMS Portal</h1>
                    <p class="lead text-muted mb-5">
                        Student Information Management System.<br />
                        Please log in to access your academic dashboard.
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="Account/Login" class="btn btn-gradient-primary btn-lg px-5 rounded-pill shadow-lg">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Log In
                        </a>
                        <a href="Account/Register" class="btn btn-outline-primary btn-lg px-5 rounded-pill">
                            Register
                        </a>
                    </div>
                </div>
            </div>
        </NotAuthorized>

        <Authorized>
            @if (showFallbackMessage)
            {
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-circle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p class="lead text-muted">@fallbackMessage</p>
                    <a class="btn btn-primary rounded-pill px-4" href="@AppRoutes.ManageAccount">Go to profile</a>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">@redirectMessage</p>
                </div>
            }
        </Authorized>
    </AuthorizeView>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = default!;

    private string redirectMessage = "Preparing your workspace...";
    private bool showFallbackMessage;
    private string fallbackMessage = "Unable to determine your dashboard.";

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateTask;
        var user = authState.User;

        if (user?.Identity is null || !user.Identity.IsAuthenticated)
        {
            return;
        }

        var (targetRoute, message) = ResolveDashboardRoute(user);
        redirectMessage = message;

        if (!string.IsNullOrWhiteSpace(targetRoute))
        {
            NavigationManager.NavigateTo(targetRoute!);
        }
        else
        {
            showFallbackMessage = true;
            fallbackMessage = message;
        }
    }

    private static (string? Route, string Message) ResolveDashboardRoute(ClaimsPrincipal user)
    {
        if (user.IsInRole("Admin"))
        {
            return (AppRoutes.AdminDashboard, "Opening the admin hub...");
        }

        if (user.IsInRole("Lecture") || user.IsInRole("Lecturer"))
        {
            return (AppRoutes.LecturerWorkspace, "Loading your lecturer workspace...");
        }

        if (user.IsInRole("Student"))
        {
            return (AppRoutes.StudentDashboard, "Taking you to your student dashboard...");
        }

        return (null, "Your account does not have an assigned dashboard yet.");
    }
}