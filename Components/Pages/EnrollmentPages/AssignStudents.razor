@page "/enrollments/assign"
@page "/enrollments/assign-students"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using FinalAssignemnt_APDP.Data
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Assign Students to Course</PageTitle>

<div>
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-semibold text-slate-900"><span class="bi bi-person-plus text-indigo-600 mr-2"></span>Assign Students to Course</h1>
        <a href="/enrollments" class="inline-flex items-center gap-2 rounded-full bg-slate-50 px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-100">
            <span class="bi bi-arrow-left"></span> Back to List
        </a>
    </div>

    <section class="mt-6 rounded-2xl border border-slate-100 bg-white p-6 shadow-sm">
        <div class="mb-6">
            <EditForm Model="Model" OnValidSubmit="AssignStudent" FormName="assign" data-enhance="false">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-rose-600" role="alert" />

                <div class="mb-4">
                    <label for="courseId" class="block text-sm font-medium text-slate-700">Course</label>
                    <InputSelect id="courseId" @bind-Value="Model.CourseId" @bind-Value:after="OnCourseChangedAsync" class="mt-1 block w-full rounded-md border border-slate-200 bg-white py-2 px-3 text-sm text-slate-700">
                        <option value="0">-- Select Course --</option>
                        @foreach (var course in Courses)
                        {
                            <option value="@course.Id">@course.Name (@(course.Subject?.Name ?? "Unknown") - @(course.Semester?.Name ?? "Unknown"))</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Model.CourseId" class="text-rose-600 text-sm" />
                </div>

                <div class="mb-4">
                    <label for="studentIds" class="block text-sm font-medium text-slate-700">Students</label>
                    <select id="studentIds" multiple class="mt-1 block w-full rounded-md border border-slate-200 bg-white py-2 px-3 text-sm text-slate-700" style="width: 100%;"></select>
                    <p class="mt-1 text-xs text-slate-500">Search and select students to assign to this course</p>
                </div>

                @if (SelectedCourseId > 0)
                {
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-slate-900">Currently Enrolled Students</h3>
                        @if (EnrolledStudents.Any())
                        {
                            <ul class="mt-3 divide-y divide-slate-100">
                                @foreach (var student in EnrolledStudents)
                                {
                                    <li class="py-3 flex items-center justify-between">
                                        <div class="text-sm text-slate-700">@(student.Student?.Name ?? "Unknown") <span class="text-xs text-slate-400">(@(student.Student?.StudentId ?? ""))</span> <span class="text-xs text-slate-400">- @(student.Student?.Email ?? "")</span></div>
                                        <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-rose-600 px-3 py-1.5 text-xs font-medium text-white transition hover:bg-rose-500" @onclick="() => RemoveEnrollment(student.Id)">
                                            <span class="bi bi-trash"></span> Remove
                                        </button>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="mt-2 text-sm text-slate-500">No students enrolled in this course yet.</p>
                        }
                    </div>
                }

                <div class="mt-4">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500" disabled="@(SelectedCourseId == 0)">
                        <span class="bi bi-check-circle"></span> Assign Students
                    </button>
                </div>
            </EditForm>
        </div>
    </section>
</div>

@code {
    [SupplyParameterFromForm]
    private AssignModel Model { get; set; } = new();

    [SupplyParameterFromQuery]
    private int? CourseId { get; set; }

    private List<Course> Courses { get; set; } = new();
    private List<Enrollment> EnrolledStudents { get; set; } = new();
    private int SelectedCourseId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Courses = await context.Courses
            .Include(c => c.Subject)
            .Include(c => c.Semester)
            .AsNoTracking()
            .ToListAsync();

        if (CourseId.HasValue && CourseId.Value > 0)
        {
            SelectedCourseId = CourseId.Value;
            Model.CourseId = CourseId.Value;
            await LoadEnrolledStudents(CourseId.Value);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeSelect2();
        }
        else
        {
            try
            {
                var elementExists = await JSRuntime.InvokeAsync<bool>("eval", "$('#studentIds').length > 0 && !$('#studentIds').hasClass('select2-hidden-accessible')");
                if (elementExists)
                {
                    await InitializeSelect2();
                }
            }
            catch { }
        }
    }

    private async Task InitializeSelect2()
    {
        await Task.Delay(500);
        try
        {
            await JSRuntime.InvokeVoidAsync("initStudentSelect2");

            try
            {
                var current = EnrolledStudents.Select(e => new {
                    id = e.StudentID,
                    text = $"{e.Student.Name} ({e.Student.StudentId}) - {e.Student.Email}"
                }).ToArray();

                await JSRuntime.InvokeVoidAsync("setSelectedStudents", current);
            }
            catch { }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing Select2: {ex.Message}");
        }
    }

    private async Task OnCourseChangedAsync()
    {
        if (Model.CourseId > 0)
        {
            SelectedCourseId = Model.CourseId;
            await LoadEnrolledStudents(Model.CourseId);
            try
            {
                var current = EnrolledStudents.Select(e => new {
                    id = e.StudentID,
                    text = $"{e.Student.Name} ({e.Student.StudentId}) - {e.Student.Email}"
                }).ToArray();

                await JSRuntime.InvokeVoidAsync("setSelectedStudents", current);
            }
            catch { }
        }
    }

    private async Task LoadEnrolledStudents(int courseId)
    {
        using var context = DbFactory.CreateDbContext();
        // Exclude template enrollments (those without a StudentID) so the UI
        // doesn't display an "Unknown" list item for course templates.
        EnrolledStudents = await context.Enrollments
            .Include(e => e.Student)
            .Where(e => e.CourseID == courseId && !string.IsNullOrWhiteSpace(e.StudentID))
            .ToListAsync();
    }

    private async Task AssignStudent()
    {
        if (SelectedCourseId == 0) return;

        try
        {
            var selectedStudentIds = await JSRuntime.InvokeAsync<string[]>("getSelectedStudents");

            if (selectedStudentIds == null || selectedStudentIds.Length == 0)
            {
                return;
            }

            using var context = DbFactory.CreateDbContext();
            var existingEnrollments = await context.Enrollments
                .Where(e => e.CourseID == SelectedCourseId && selectedStudentIds.Contains(e.StudentID))
                .Select(e => e.StudentID)
                .ToListAsync();

            var newStudentIds = selectedStudentIds.Except(existingEnrollments).ToList();

            // Try to preserve schedule details by copying from a course-level template
            var template = await context.Enrollments
                .Where(e => e.CourseID == SelectedCourseId && e.StudentID == null)
                .OrderByDescending(e => e.TotalSlots)
                .FirstOrDefaultAsync();

            foreach (var studentId in newStudentIds)
            {
                var enrollment = new Enrollment
                {
                    StudentID = studentId,
                    CourseID = SelectedCourseId,
                    DayOfWeek = template?.DayOfWeek,
                    Room = template?.Room,
                    TimeSlot = template?.TimeSlot,
                    TotalSlots = template?.TotalSlots
                };

                context.Enrollments.Add(enrollment);
            }

            await context.SaveChangesAsync();
            await LoadEnrolledStudents(SelectedCourseId);
            try
            {
                var current = EnrolledStudents.Select(e => new {
                    id = e.StudentID,
                    text = $"{e.Student.Name} ({e.Student.StudentId}) - {e.Student.Email}"
                }).ToArray();

                await JSRuntime.InvokeVoidAsync("setSelectedStudents", current);
            }
            catch { }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error assigning students: {ex.Message}");
        }
        
        StateHasChanged();
    }

    private async Task RemoveEnrollment(int enrollmentId)
    {
        using var context = DbFactory.CreateDbContext();
        var enrollment = await context.Enrollments.FindAsync(enrollmentId);
        if (enrollment != null)
        {
            context.Enrollments.Remove(enrollment);
            await context.SaveChangesAsync();
            await LoadEnrolledStudents(SelectedCourseId);
            try
            {
                var current = EnrolledStudents.Select(e => new {
                    id = e.StudentID,
                    text = $"{e.Student.Name} ({e.Student.StudentId}) - {e.Student.Email}"
                }).ToArray();

                await JSRuntime.InvokeVoidAsync("setSelectedStudents", current);
            }
            catch { }

            StateHasChanged();
        }
    }

    private sealed class AssignModel
    {
        public int CourseId { get; set; }
    }
}
