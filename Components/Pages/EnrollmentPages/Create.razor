@page "/enrollments/create"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.EntityFrameworkCore
@using FinalAssignemnt_APDP.Components.Enrollments
@using FinalAssignemnt_APDP.Data
@using FinalAssignemnt_APDP.Constants
@inject IDbContextFactory<FinalAssignemnt_APDP.Data.ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Create Enrollment</PageTitle>

<div class="max-w-3xl space-y-6">
<div>
    <h1 class="text-2xl font-semibold text-slate-900">Create enrollment</h1>
    <p class="text-sm text-slate-500">Create a course enrollment with schedule details. Students can be assigned later.</p>
</div>

    <div class="rounded-2xl bg-white p-6 shadow-sm">
        @if (Courses.Count == 0)
        {
            <div class="space-y-3 text-sm text-slate-600">
                <p class="font-medium text-slate-900">Missing related data</p>
                <p>- No courses available. Please create a course first.</p>
            </div>
        }
        else
        {
            <EditForm method="post" Model="Enrollment" OnValidSubmit="AddEnrollment" FormName="create" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="mb-4 text-sm text-rose-600" role="alert" />
                @if (!string.IsNullOrWhiteSpace(ErrorMessage))
                {
                    <p class="mb-4 rounded-lg bg-rose-50 px-3 py-2 text-sm text-rose-700">@ErrorMessage</p>
                }

                <div class="space-y-1">
                    <label for="courseid" class="text-sm font-medium text-slate-700">Course</label>
                    <InputSelect id="courseid" 
                                 @bind-Value="Enrollment.CourseID"
                                 class="w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100">
                        <option value="0">-- Select course --</option>
                        @foreach (var course in Courses)
                        {
                            <option value="@course.Id">@EnrollmentDisplayHelper.FormatCourseOption(course)</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Enrollment.CourseID" class="text-sm text-rose-600" />
                </div>

                <div class="mt-4 rounded-2xl border border-slate-100 bg-slate-50/70 p-4">
                    <p class="text-sm font-semibold text-slate-800">Schedule details (optional)</p>
                    <p class="text-xs text-slate-500">Capture the days, time slot, room, and slot count so the timetable stays accurate.</p>

                    <div class="mt-4 space-y-4">
                        <div class="space-y-1">
                            <label for="day-input" class="text-sm font-medium text-slate-700">Days of the week</label>
                            <InputText id="day-input"
                                       name="Enrollment.DayOfWeek"
                                       placeholder="<Monday, Wednesday, Friday>"
                                       @bind-Value="DayInput"
                                       @bind-Value:event="oninput"
                                       class="w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" />
                            <p class="text-xs text-slate-500">Enter comma-separated numbers (1 = Monday … 7 = Sunday).</p>
                        </div>

                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="space-y-1">
                                <label for="time-slot" class="text-sm font-medium text-slate-700">Time slot</label>
                                <InputSelect id="time-slot"
                                             name="Enrollment.TimeSlot"
                                             @bind-Value="SelectedTimeBlockLabel"
                                             class="w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100">
                                    <option value="">-- Select 4-hour block --</option>
                                    @foreach (var block in TimeBlockCatalog.All)
                                    {
                                        <option value="@block.Label">@block.Label</option>
                                    }
                                </InputSelect>
                                <p class="text-xs text-slate-500">Each block spans four hours.</p>
                            </div>
                            <div class="space-y-1">
                                <label for="totalslots" class="text-sm font-medium text-slate-700">Total slots</label>
                                <InputNumber TValue="int?"
                                             id="totalslots"
                                             @bind-Value="Enrollment.TotalSlots"
                                             min="0"
                                             class="w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" />
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label for="room" class="text-sm font-medium text-slate-700">Room</label>
                            <InputText id="room"
                                       placeholder="e.g. Lab 3"
                                       class="w-full rounded-lg border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100"
                                       @bind-Value="Enrollment.Room" />
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex items-center gap-3">
                    <button type="submit" class="inline-flex items-center rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white transition hover:bg-indigo-500">Create</button>
                    <a href="/enrollments" class="text-sm font-semibold text-slate-600 hover:text-slate-900">Cancel</a>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private Enrollment Enrollment { get; set; } = new();

    private List<Course> Courses { get; set; } = new();
    private string? ErrorMessage { get; set; }
    private EnrollmentScheduleState ScheduleState = default!;
    private string _dayInput = string.Empty;
    private string SelectedTimeBlockLabel
    {
        get => Enrollment.TimeSlot ?? string.Empty;
        set
        {
            Enrollment.TimeSlot = string.IsNullOrWhiteSpace(value) ? null : value;

            if (ScheduleState is null)
            {
                return;
            }

            if (string.IsNullOrWhiteSpace(value))
            {
                ScheduleState.StartTime = null;
                ScheduleState.EndTime = null;
                return;
            }

            if (TimeBlockCatalog.TryGetByLabel(value, out var block) && block is not null)
            {
                ScheduleState.StartTime = block.Start;
                ScheduleState.EndTime = block.End;
            }
        }
    }
    private string DayInput
    {
        get => _dayInput;
        set => ApplyDayInput(value);
    }

    protected override async Task OnInitializedAsync()
    {
        ScheduleState = new EnrollmentScheduleState(Enrollment);
        SyncDayInputFromState();

        using var context = DbFactory.CreateDbContext();

        Courses = await context.Courses
            .Include(c => c.Subject)
            .Include(c => c.Semester)
            .OrderBy(c => c.Name)
            .ThenBy(c => c.Id)
            .ToListAsync();

    }

    private async Task AddEnrollment()
    {
        ErrorMessage = null;
        ScheduleState.Persist();

        if (Enrollment.CourseID <= 0)
        {
            ErrorMessage = "Please select a course.";
            return;
        }

        if (Enrollment.TotalSlots is < 0)
        {
            ErrorMessage = "Total slots cannot be negative.";
            return;
        }

        using var context = DbFactory.CreateDbContext();

        var courseExists = await context.Courses.AnyAsync(c => c.Id == Enrollment.CourseID);
        if (!courseExists)
        {
            ErrorMessage = "Invalid course ID.";
            Courses = await context.Courses.Include(c => c.Subject).Include(c => c.Semester).OrderBy(c => c.Name).ThenBy(c => c.Id).ToListAsync();
            return;
        }

        // Note: StudentID will need to be set separately, possibly through a different flow
        // This page now only creates the course enrollment template
        context.Enrollments.Add(Enrollment);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo(AppRoutes.Enrollments);
    }

    private void ApplyDayInput(string? value)
    {
        _dayInput = value ?? string.Empty;

        if (ScheduleState is null)
        {
            return;
        }

        ScheduleState.SelectedDays.Clear();

        var tokens = _dayInput
            .Split(new[] { ',', ';', '\n', '\r', '\t', ' ' }, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        foreach (var token in tokens)
        {
            if (WeekdayCatalog.TryResolveDay(token, out var day))
            {
                ScheduleState.SelectedDays.Add(day);
            }
        }

        ScheduleState.Persist();
    }

    private void SyncDayInputFromState()
    {
        _dayInput = ScheduleState.SelectedDays.Count == 0
            ? string.Empty
            : WeekdayCatalog.Serialize(ScheduleState.SelectedDays);
    }

}   