@page "/enrollments"
@attribute [Authorize(Roles = "Admin,Lecture,Lecturer")]
@using Microsoft.EntityFrameworkCore
@using FinalAssignemnt_APDP.Constants
@using FinalAssignemnt_APDP.Data
@implements IAsyncDisposable
@inject IDbContextFactory<FinalAssignemnt_APDP.Data.ApplicationDbContext> DbFactory

<PageTitle>Enrollments</PageTitle>

<div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold text-slate-900">Enrollments</h1>
    <AuthorizeView Roles="Admin">
        <Authorized>
            <div class="flex gap-2">
                <a href="enrollments/assign-students" class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-500">
                    <span class="bi bi-people-fill"></span> Assign Students
                </a>
                <a href="enrollments/create" class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500">
                    <span class="text-lg">+</span> New Enrollment
                </a>
            </div>
        </Authorized>
    </AuthorizeView>
</div>

@if (classSchedule.Count > 0)
{
    <section class="mt-8 rounded-2xl border border-slate-100 bg-white p-6 shadow-sm">
        <div class="mb-6 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Class timetable</p>
                <h2 class="text-xl font-semibold text-slate-900">Weekly schedule derived from enrollments</h2>
                <p class="text-sm text-slate-500">Each section below reflects the meeting info saved on the enrollment records.</p>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 px-4 py-2 text-xs font-semibold text-slate-600">
                <span class="bi bi-journal-check"></span> @classSchedule.Count classes
            </span>
        </div>

        <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
            @foreach (var card in classSchedule)
            {
                <article class="rounded-2xl border border-slate-100 bg-slate-50/60 p-5">
                    <div class="flex flex-col gap-2 border-b border-slate-100 pb-4">
                        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">@card.Semester</p>
                        <h3 class="text-lg font-semibold text-slate-900">@card.CourseName</h3>
                        <p class="text-sm text-slate-500">@card.Subject</p>
                        <p class="text-xs text-slate-500">Lecturer: @card.Lecturer</p>
                    </div>
                    <div class="mt-4 space-y-3">
                        @foreach (var slot in card.Slots)
                        {
                            <div class="rounded-xl border border-white/70 bg-white px-4 py-3 shadow-sm">
                                <p class="text-sm font-semibold text-slate-900">@slot.Day</p>
                                <p class="text-sm text-slate-600">@slot.Time</p>
                                <p class="text-xs text-slate-500">Room @slot.Room</p>
                            </div>
                        }
                        @if (card.Slots.Count == 0)
                        {
                            <div class="rounded-xl border border-dashed border-slate-200 px-4 py-3 text-center text-xs text-slate-500">
                                No schedule captured yet.
                            </div>
                        }
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2 text-xs text-slate-500">
                        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1">
                            <span class="bi bi-people"></span> @card.StudentCount students
                        </span>
                        @if (card.TotalSlots is not null)
                        {
                            <span class="inline-flex items-center gap-1 rounded-full bg-white px-3 py-1 text-slate-700 shadow-sm">
                                <span class="bi bi-hourglass-split"></span> @card.TotalSlots slots
                            </span>
                        }
                        <a href="@AppRoutes.CoursesDetails(card.CourseId)" class="inline-flex items-center gap-1 rounded-full bg-white px-3 py-1 text-slate-700 shadow-sm transition hover:text-slate-900">
                            <span class="bi bi-box-arrow-up-right"></span> Course info
                        </a>
                    </div>
                </article>
            }
        </div>
    </section>
}

@if (courseEnrollments.Count == 0)
{
    <div class="mt-6 rounded-md border border-dashed border-slate-200 bg-white/60 p-6 text-center text-slate-500">
        No enrollments found.
    </div>
}
else
{
    <div class="mt-6 overflow-hidden rounded-xl bg-white shadow-sm">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-slate-600">
                    <th class="px-6 py-3">Course</th>
                    <th class="px-6 py-3">Semester</th>
                    <th class="px-6 py-3">Lecturer</th>
                    <th class="px-6 py-3">Schedule</th>
                    <th class="px-6 py-3">Slots</th>
                    <th class="px-6 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white">
                @foreach (var courseGroup in courseEnrollments)
                {
                    var firstEnrollment = courseGroup.Enrollments.First();
                    var course = firstEnrollment.Course;
                    
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4">
                            <p class="font-medium text-slate-900">@course?.Name</p>
                            <p class="text-xs text-slate-500">@GetCourseMeta(course)</p>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="inline-flex items-center gap-1 rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-700">
                                    <span class="bi bi-people-fill"></span> @courseGroup.StudentCount student@(courseGroup.StudentCount != 1 ? "s" : "")
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-700">@GetSemesterName(course?.Semester)</td>
                        <td class="px-6 py-4 text-slate-700">@GetLecturerDisplayName(course?.Lecture, course?.LectureID)</td>
                        <td class="px-6 py-4 text-slate-700">
                            @if (HasScheduleDetails(firstEnrollment))
                            {
                                <div class="space-y-2">
                                    @if (!string.IsNullOrWhiteSpace(firstEnrollment.DayOfWeek))
                                    {
                                        <div>
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Days</p>
                                            <p>@FormatDayPattern(firstEnrollment.DayOfWeek)</p>
                                        </div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(firstEnrollment.TimeSlot))
                                    {
                                        <div>
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Time</p>
                                            <p>@firstEnrollment.TimeSlot</p>
                                        </div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(firstEnrollment.Room))
                                    {
                                        <div>
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Room</p>
                                            <p>Room @firstEnrollment.Room</p>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-slate-400">—</span>
                            }
                        </td>
                        <td class="px-6 py-4 text-slate-700">
                            @if (courseGroup.TotalSlots is null)
                            {
                                <span class="text-slate-400">—</span>
                            }
                            else
                            {
                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
                                    <span class="bi bi-hourglass-split"></span> @courseGroup.TotalSlots
                                </span>
                            }
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-end gap-1.5">
                                <a href="@($"enrollments/details?id={firstEnrollment.Id}")" 
                                   class="inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-medium text-slate-700 transition hover:bg-slate-50 hover:border-slate-300"
                                   title="View details">
                                    <span class="bi bi-eye"></span>
                                    <span class="hidden sm:inline">Details</span>
                                </a>
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <a href="@($"enrollments/edit?id={firstEnrollment.Id}")" 
                                           class="inline-flex items-center gap-1 rounded-lg bg-indigo-600 px-2.5 py-1.5 text-xs font-medium text-white transition hover:bg-indigo-500"
                                           title="Edit enrollment">
                                            <span class="bi bi-pencil-fill"></span>
                                            <span class="hidden sm:inline">Edit</span>
                                        </a>
                                        <a href="@($"enrollments/delete?id={firstEnrollment.Id}")" 
                                           class="inline-flex items-center gap-1 rounded-lg bg-rose-600 px-2.5 py-1.5 text-xs font-medium text-white transition hover:bg-rose-500"
                                           title="Delete enrollment">
                                            <span class="bi bi-trash-fill"></span>
                                            <span class="hidden sm:inline">Delete</span>
                                        </a>
                                        <a href="@AppRoutes.CoursesDetails(courseGroup.CourseId)" 
                                           class="inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-medium text-slate-700 transition hover:bg-slate-50 hover:border-slate-300"
                                           title="View course">
                                            <span class="bi bi-box-arrow-up-right"></span>
                                            <span class="hidden sm:inline">Course</span>
                                        </a>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
private ApplicationDbContext context = default!;
private List<Enrollment> enrollments = new();
private readonly List<ClassScheduleCard> classSchedule = new();
private List<CourseEnrollmentGroup> courseEnrollments = new();

protected override async Task OnInitializedAsync()
{
    context = DbFactory.CreateDbContext();
    enrollments = await context.Enrollments
        .Include(e => e.Course)
            .ThenInclude(c => c.Subject)
        .Include(e => e.Course)
            .ThenInclude(c => c.Semester)
        .Include(e => e.Course)
            .ThenInclude(c => c.Lecture)
        .OrderBy(e => e.StudentID)
        .ThenBy(e => e.Course!.Name)
        .ThenBy(e => e.Id)
        .ToListAsync();

    // Hydrate Student info without relying on FK join
    var studentIds = enrollments
        .Select(e => e.StudentID)
        .Where(id => !string.IsNullOrWhiteSpace(id))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .ToList();

    var students = await context.Users
        .Where(u => studentIds.Contains(u.Id))
        .ToDictionaryAsync(u => u.Id, u => u);

    foreach (var e in enrollments)
    {
        if (!string.IsNullOrWhiteSpace(e.StudentID) && students.TryGetValue(e.StudentID!, out var s))
        {
            e.Student = s;
        }
    }

    BuildClassSchedule();
    BuildCourseEnrollments();
}

private void BuildCourseEnrollments()
{
    courseEnrollments = enrollments
        .Where(e => e.Course != null)
        .GroupBy(e => e.CourseID)
        .Select(g => new CourseEnrollmentGroup
        {
            CourseId = g.Key,
            Enrollments = g.ToList(),
            StudentCount = g.Select(e => e.StudentID).Where(id => !string.IsNullOrWhiteSpace(id)).Distinct(StringComparer.OrdinalIgnoreCase).Count(),
            TotalSlots = g.Max(e => e.TotalSlots)
        })
        .OrderBy(g => g.Enrollments.First().Course?.Name)
        .ToList();
}

    private void BuildClassSchedule()
    {
        classSchedule.Clear();
        var groups = enrollments
            .Where(e => e.Course is not null)
            .GroupBy(e => e.CourseID)
            .OrderBy(g => g.First().Course?.Name)
            .ToList();

        foreach (var group in groups)
        {
            var course = group.First().Course!;
            var lecturerName = GetLecturerDisplayName(course.Lecture, course.LectureID);
            var slots = BuildSlots(group);

            classSchedule.Add(new ClassScheduleCard
            {
                CourseId = course.Id,
                CourseName = course.Name,
                Subject = GetCourseMeta(course),
                Semester = GetSemesterName(course.Semester),
                Lecturer = lecturerName,
                StudentCount = group.Select(e => e.StudentID).Distinct(StringComparer.OrdinalIgnoreCase).Count(),
                Slots = slots,
                TotalSlots = group.Max(e => e.TotalSlots)
            });
        }
    }

    private static List<ClassScheduleSlot> BuildSlots(IEnumerable<Enrollment> enrollments)
    {
        var slots = new List<ClassScheduleSlot>();
        var seen = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

        foreach (var enrollment in enrollments)
        {
            var time = string.IsNullOrWhiteSpace(enrollment.TimeSlot) ? "Time TBD" : enrollment.TimeSlot!;
            var room = string.IsNullOrWhiteSpace(enrollment.Room) ? "TBD" : enrollment.Room!;
            var dayOptions = WeekdayCatalog.FromStoredValue(enrollment.DayOfWeek);

            if (dayOptions.Count == 0)
            {
                AddSlot("Day TBD", 7);
            }
            else
            {
                foreach (var option in dayOptions)
                {
                    AddSlot(option.Display, (int)option.Day);
                }
            }

            void AddSlot(string dayLabel, int sortKey)
            {
                var key = string.Join('|', dayLabel, time, room);
                if (seen.Add(key))
                {
                    slots.Add(new ClassScheduleSlot
                    {
                        Day = dayLabel,
                        Time = time,
                        Room = room,
                        SortKey = sortKey
                    });
                }
            }
        }

        return slots
            .OrderBy(slot => slot.SortKey)
            .ThenBy(slot => slot.Time, StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private static bool HasScheduleDetails(Enrollment enrollment)
        => !(string.IsNullOrWhiteSpace(enrollment.DayOfWeek)
             && string.IsNullOrWhiteSpace(enrollment.TimeSlot)
             && string.IsNullOrWhiteSpace(enrollment.Room));

    private static string FormatDayPattern(string? dayPattern)
    {
        var options = WeekdayCatalog.FromStoredValue(dayPattern);
        if (options.Count == 0)
        {
            return dayPattern ?? string.Empty;
        }

        var names = string.Join(", ", options.Select(option => option.Label));
        return $"{names}";
    }

    private static string GetStudentDisplayName(ApplicationUser? student, string? fallbackId)
    {
        if (student is null)
        {
            return fallbackId ?? string.Empty;
        }

        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(student.StudentId))
        {
            parts.Add(student.StudentId!);
        }
        if (!string.IsNullOrWhiteSpace(student.Name))
        {
            parts.Add(student.Name!);
        }
        return parts.Count == 0 ? (fallbackId ?? string.Empty) : string.Join(" - ", parts);
    }

    private static string GetCourseMeta(Course? course)
    {
        if (course is null)
        {
            return string.Empty;
        }

        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(course.Subject?.Name))
        {
            parts.Add(course.Subject!.Name);
        }
        if (!string.IsNullOrWhiteSpace(course.Subject?.Code))
        {
            parts.Add(course.Subject!.Code);
        }
        return parts.Count == 0 ? $"Course #{course.Id}" : string.Join(" • ", parts);
    }

    private static string GetSemesterName(Semester? semester) => string.IsNullOrWhiteSpace(semester?.Name) ? "—" : semester!.Name!;

    private static string GetLecturerDisplayName(ApplicationUser? lecturer, string? fallbackId)
    {
        if (lecturer is null)
        {
            return string.IsNullOrWhiteSpace(fallbackId) ? "—" : fallbackId!;
        }

        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(lecturer.Name))
        {
            parts.Add(lecturer.Name!);
        }

        if (!string.IsNullOrWhiteSpace(lecturer.Email))
        {
            parts.Add(lecturer.Email!);
        }

        return parts.Count == 0 ? (fallbackId ?? "—") : string.Join(" • ", parts);
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();

    private sealed class ClassScheduleCard
    {
        public int CourseId { get; set; }
        public string CourseName { get; set; } = string.Empty;
        public string Subject { get; set; } = string.Empty;
        public string Semester { get; set; } = string.Empty;
        public string Lecturer { get; set; } = string.Empty;
        public int StudentCount { get; set; }
        public List<ClassScheduleSlot> Slots { get; set; } = new();
        public int? TotalSlots { get; set; }
    }

    private sealed class ClassScheduleSlot
    {
        public string Day { get; set; } = "Day TBD";
        public string Time { get; set; } = "Time TBD";
        public string Room { get; set; } = "TBD";
        public int SortKey { get; set; } = 7;
    }

    private sealed class CourseEnrollmentGroup
    {
        public int CourseId { get; set; }
        public List<Enrollment> Enrollments { get; set; } = new();
        public int StudentCount { get; set; }
        public int? TotalSlots { get; set; }
    }
}